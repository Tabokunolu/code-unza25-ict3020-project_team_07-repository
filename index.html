<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>Wikipedia Edit Statistics + Facebook Plugins</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Open Graph (Facebook preview) -->
  <meta property="og:title" content="Wikipedia Edit Statistics" />
  <meta property="og:description" content="Check Wikipedia edit history and share with Facebook plugins." />
  <meta property="og:type" content="website" />

  <style>
    /* Theme Colors using CSS Variables */
    :root {
      --bg: #f8fafc;
      --text: #0f172a;
      --card-bg: #ffffff;
      --header-bg: #111827;
      --stat-bg: #f1f5f9;
    }
    [data-theme="dark"] {
      --bg: #0f172a;
      --text: #f8fafc;
      --card-bg: #1e293b;
      --header-bg: #111827;
      --stat-bg: #334155;
    }

    body {
      margin: 0;
      font-family: system-ui, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
    }
    header {
      display: flex;
      justify-content: space-between;
      padding: 16px;
      background: var(--header-bg);
      color: white;
    }
    .wrap {
      max-width: 960px;
      margin: auto;
      padding: 20px;
      display: grid;
      gap: 20px;
    }
    .card {
      background: var(--card-bg);
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 20px;
      transition: background 0.3s;
    }
    .inputs {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
    }
    .btn {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      background: #2563eb;
      color: white;
      cursor: pointer;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    .stat {
      background: var(--stat-bg);
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      transition: background 0.3s;
    }
    .stat .k { font-size: 20px; font-weight: bold; }
    .note { font-size: 14px; color: gray; }
    .error { color: red; font-weight: bold; }
  </style>
</head>

<body>
  <!-- Facebook SDK -->
  <div id="fb-root"></div>

  <header>
    <span>ðŸ§­ Wikipedia Edit Statistics</span>
    <button id="themeBtn">ðŸŒ— Theme</button>
  </header>

  <main class="wrap">

    <!-- Objectives -->
    <section class="card">
      <h3>System Objectives</h3>
      <ul>
        <li>ðŸ“Š Visualize key editing metrics (top editors, most edited articles, edit frequency).</li>
        <li>ðŸ”Ž Provide detailed insights into edit history and contributor statistics.</li>
        <li>ðŸ‘¤ Create profiles for top Wikipedia editors (showing contributions & expertise).</li>
        <li>ðŸ’¬ Encourage community engagement with Facebook share, like, and comments.</li>
      </ul>
    </section>

    <!-- Query Section -->
    <section class="card">
      <div class="inputs">
        <input id="titleInput" type="text" placeholder="Enter Wikipedia article (e.g., Nelson Mandela)" />
        <button id="fetchBtn" class="btn">Fetch Stats</button>
      </div>
      <div id="status" class="note"></div>
      <div class="stats" id="stats" hidden>
        <div class="stat"><div class="k" id="totalEdits">â€”</div><div class="l">Total Edits</div></div>
        <div class="stat"><div class="k" id="uniqueEditors">â€”</div><div class="l">Unique Editors</div></div>
        <div class="stat"><div class="k" id="firstEdit">â€”</div><div class="l">First Edit</div></div>
        <div class="stat"><div class="k" id="lastEdit">â€”</div><div class="l">Last Edit</div></div>
      </div>
      <div id="articleLink" class="note" style="margin-top:10px;"></div>
      <div id="error" class="error"></div>
    </section>

    <!-- Charts -->
    <section class="card">
      <h3>Top Editors (Pie Chart)</h3>
      <canvas id="pieChart" height="200"></canvas>
      <h3>Edit Frequency (Bar Chart)</h3>
      <canvas id="barChart" height="200"></canvas>
    </section>

    <!-- Facebook Plugins -->
    <section class="card">
      <div class="note">Discuss and share insights:</div>
      <div class="fb-share-button" data-href="" data-layout="button_count"></div>
      <div class="fb-like" data-href="" data-layout="standard" data-share="true"></div>
      <div class="fb-comments" data-href="" data-width="100%" data-numposts="5"></div>
    </section>
  </main>

  <!-- Facebook SDK -->
  <script async defer crossorigin="anonymous"
    src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v19.0"></script>

  <script>
    const fetchBtn = document.getElementById('fetchBtn');
    const titleInput = document.getElementById('titleInput');
    const elStats = document.getElementById('stats');
    const elStatus = document.getElementById('status');
    const elError = document.getElementById('error');
    const elTotal = document.getElementById('totalEdits');
    const elUnique = document.getElementById('uniqueEditors');
    const elFirst = document.getElementById('firstEdit');
    const elLast = document.getElementById('lastEdit');
    const elArticleLink = document.getElementById('articleLink');
    const themeBtn = document.getElementById('themeBtn');

    let pieChart, barChart;

    async function fetchAllRevisions(article) {
      const base = `https://en.wikipedia.org/w/api.php`;
      const params = new URLSearchParams({
        action: 'query',
        prop: 'revisions',
        titles: article,
        rvprop: 'timestamp|user',
        rvlimit: '500',
        rvdir: 'newer',
        format: 'json',
        formatversion: '2',
        origin: '*'
      });

      let all = [], cont;
      do {
        const url = base + '?' + params.toString();
        const res = await fetch(url);
        const data = await res.json();
        const pages = data.query?.pages || [];
        if (!pages.length || pages[0].missing) throw new Error("Article not found.");
        all = all.concat(pages[0].revisions || []);
        cont = data.continue?.rvcontinue;
        if (cont) params.set('rvcontinue', cont);
      } while (cont);
      return all;
    }

    function fmtDate(iso) {
      return new Date(iso).toLocaleString();
    }

    async function handleFetch() {
      const article = titleInput.value.trim();

      elError.textContent = "";
      elStats.hidden = true;
      elStatus.textContent = "Fetching revisionsâ€¦";
      fetchBtn.disabled = true;

      try {
        if (!article) throw new Error("Please enter an article title.");

        const revisions = await fetchAllRevisions(article);
        if (!revisions.length) throw new Error("No revisions found.");

        // Stats
        const totalEdits = revisions.length;
        const uniqueEditors = new Set(revisions.map(r => r.user)).size;
        const first = revisions[0];
        const last = revisions[revisions.length - 1];

        elTotal.textContent = totalEdits.toLocaleString();
        elUnique.textContent = uniqueEditors.toLocaleString();
        elFirst.textContent = fmtDate(first.timestamp);
        elLast.textContent = fmtDate(last.timestamp);
        elStats.hidden = false;

        // Article link
        const articleURL = `https://en.wikipedia.org/wiki/${encodeURIComponent(article)}`;
        elArticleLink.innerHTML = `ðŸ”— <a href="${articleURL}" target="_blank">${articleURL}</a>`;

        // Prepare editor counts
        const editorCounts = {};
        revisions.forEach(r => editorCounts[r.user] = (editorCounts[r.user] || 0) + 1);
        const topEditors = Object.entries(editorCounts)
          .sort((a,b) => b[1]-a[1])
          .slice(0, 5);

        // Pie chart
        if (pieChart) pieChart.destroy();
        pieChart = new Chart(document.getElementById('pieChart'), {
          type: 'pie',
          data: {
            labels: topEditors.map(e => e[0]),
            datasets: [{
              data: topEditors.map(e => e[1]),
              backgroundColor: ['#ef4444','#3b82f6','#10b981','#f59e0b','#8b5cf6']
            }]
          }
        });

        // Bar chart
        const yearCounts = {};
        revisions.forEach(r => {
          const year = new Date(r.timestamp).getFullYear();
          yearCounts[year] = (yearCounts[year] || 0) + 1;
        });
        const years = Object.keys(yearCounts).sort();
        if (barChart) barChart.destroy();
        barChart = new Chart(document.getElementById('barChart'), {
          type: 'bar',
          data: {
            labels: years,
            datasets: [{
              label: 'Edits per Year',
              data: years.map(y => yearCounts[y]),
              backgroundColor: '#2563eb'
            }]
          },
          options: { scales: { y: { beginAtZero: true } } }
        });

        elStatus.textContent = "Done.";
      } catch (err) {
        elError.textContent = err.message;
        elStatus.textContent = "";
      } finally {
        fetchBtn.disabled = false;
      }
    }

    fetchBtn.addEventListener('click', handleFetch);
    titleInput.addEventListener('keydown', e => { if (e.key==="Enter") handleFetch(); });

    // Theme Toggle
    themeBtn.addEventListener('click', () => {
      const current = document.documentElement.getAttribute('data-theme');
      document.documentElement.setAttribute('data-theme', current === "light" ? "dark" : "light");
    });
  </script>
</body>
</html>
